# Безопасность


## Аутентификация и авторизация

В системе существуют следующие роли: 
- кандидат
- сотрудник
- HR
- рекрутер
- администратор

Роли кандидата и сотрудника на данный момент не имеют доступа в систему и не являются объектом рассмотрения.

Остальные пользователи могут ввести логин (email) и пароль (созданный ими) и, при успехе, аутентифицироваться.

Система, на основании данных о пользователе, формирует токен (по спецификации PASETO), включающий в себя обязательные поля: время истечения жизни и payload (с необходимой в дальнейшем информацией о пользователе).


### Формат прав доступа

Для организации ролей используется подход доступа к ресурсам REST.

Для управления политиками доступа - библиотека casbin.

| sub (роль) | obj (ресурс)                                                                                                                                                                                                                                                                                     | act (метод HTTP)                                                |
|------------|--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|-----------------------------------------------------------------|
| employee   | /users/{user_id}                                                                                                                                                                                                                                                                                 | GET (только если user_id равен id запрашивающего данный ресурс) |
| hr         | /users                                                                                                                                                                                                                                                                                           | GET, POST                                                       |
| hr         | /users/{user_id}                                                                                                                                                                                                                                                                                 | GET, PATCH                                                      |
| hr         | /users/{user_id}/photo                                                                                                                                                                                                                                                                           | POST                                                            |
| hr         | /users/{user_id}/contracts <br/>/users/{user_id}/passports <br/>/users/{user_id}/passports/{passport_id}/visas <br/>/users/{user_id}/vacations <br/>/users/{user_id}/scans <br/>/users/{user_id}/educations <br/>/users/{user_id}/trainings                                                      | GET, POST                                                       |
| hr         | /users/{user_id}/contracts/{contract_id} <br/>/users/{user_id}/passports/{passport_id} <br/>/users/{user_id}/passports/{passport_id}/visas/{visa_id} <br/>/users/{user_id}/vacations/{vacation_id} <br/>/users/{user_id}/educations/{education_id} <br/>/users/{user_id}/trainings/{training_id} | GET, PATCH, DELETE                                              |


### Передача токена 
Токен подписывается приватным ключом и разделяется на две части: header.payload и signature. При успешной аутентификации сервер передает клиенту 
* часть header.payload в SameSite Secure Cookie (доступно только по https и доступно из JS кода) с именем "ecabinet:token",
* часть signature в SameSite Secure HttpOnly Cookie (доступно только по https и не доступно из JS кода) c именем "ecabinet:token:sign".

Этот приём позволит избежать распространенных уязвимостей типа Cross Site Scripting (XSS), Cross Site Request Forgery (CSRF).


### Frontend
* В случае получения от сервера кода ответа 401 требуется отправить запрос по пути /api/v1/login (см. API) и убедиться в возврате кода ответа 200.
* При использовании аутентификации при помощи cookie (вышеописанным) дополнительных действий по подтверждению следующих запросов со стороны frontend не требуется.
* Запрос пользователя на logout реализуется простым удалением cookie "ecabinet:token".
* При необходимости, получая данные из "ecabinet:token", можно узнать права пользователя на совершение тех или иных действий (см. формат прав доступа) и, например, скрывать/деактивировать отдельные визуальные блоки.
